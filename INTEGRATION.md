# Интеграция Amvera LLM в Telegram бот

## Что было сделано

### 1. Создан сервис AmveraLLMService

**Файл:** `src/bot/services/amvera_llm.py`

Сервис отвечает за взаимодействие с API Amvera LLM. Основные возможности:

- Отправка запросов к API Amvera LLM (модель gpt-5)
- Обработка ошибок (HTTP ошибки, timeout, исключения)
- Логирование всех операций
- Использование конфигурации из `Config`

**Основной метод:**
```python
async def get_response(self, user_message: str) -> Optional[str]:
    """Получить ответ от Amvera LLM."""
```

### 2. Обновлен роутер chatgpt

**Файл:** `src/bot/routers/chatgpt.py`

Роутер теперь использует новый сервис `AmveraLLMService` для получения ответов от ИИ.

**Основные обработчики:**
- `/chatgpt` - активирует режим ИИ
- `/stop` - деактивирует режим ИИ
- Обработка текстовых сообщений в режиме ИИ

### 3. Обновлена конфигурация

**Файл:** `src/bot/config.py`

Добавлена поддержка переменной окружения `AMVERA_LLM_TOKEN` через класс `AmveraConfig`.

### 4. Обновлены зависимости

**Файл:** `requirements.txt`

Добавлены необходимые библиотеки:
- `python-dotenv` - для работы с переменными окружения
- `requests` - для HTTP запросов (опционально, используется aiohttp)
- `pydantic-settings` - для работы с конфигурацией

### 5. Добавлены тесты

**Файлы:**
- `tests/test_amvera_llm_service.py` - тесты для сервиса AmveraLLMService
- `tests/test_chatgpt_router.py` - обновленные тесты для роутера chatgpt

## Как использовать

### 1. Активировать режим ИИ

```
Пользователь: /chatgpt
Бот: Отправьте мне сообщение, и я отвечу с помощью ИИ. Чтобы выйти из режима ИИ, отправьте /stop.
```

### 2. Отправить сообщение

```
Пользователь: Что такое Python?
Бот: ⏳ Обрабатываю ваш запрос...
Бот: Python - это высокоуровневый язык программирования...
```

### 3. Выйти из режима ИИ

```
Пользователь: /stop
Бот: Вы вышли из режима общения с ИИ. Теперь я буду работать как эхо-бот.
```

## Архитектура

```
┌─────────────────────────────────────────────────────────────┐
│                    Telegram Bot                             │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              Routers (aiogram)                       │   │
│  │  ┌────────────────────────────────────────────────┐  │   │
│  │  │  chatgpt_router                                │  │   │
│  │  │  - /chatgpt command handler                    │  │   │
│  │  │  - /stop command handler                       │  │   │
│  │  │  - Text message handler                        │  │   │
│  │  └────────────────────────────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────┘   │
│                           │                                  │
│                           ▼                                  │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              Services                               │   │
│  │  ┌────────────────────────────────────────────────┐  │   │
│  │  │  AmveraLLMService                              │  │   │
│  │  │  - get_response(user_message)                  │  │   │
│  │  │  - Error handling                              │  │   │
│  │  │  - Logging                                     │  │   │
│  │  └────────────────────────────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────┘   │
│                           │                                  │
│                           ▼                                  │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              Config                                 │   │
│  │  - Load environment variables                       │   │
│  │  - Provide API tokens                              │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
                ┌──────────────────────────┐
                │   Amvera LLM API         │
                │   https://lllm.amvera.io │
                │   Model: gpt-5           │
                └──────────────────────────┘
```

## Обработка ошибок

Сервис `AmveraLLMService` обрабатывает следующие типы ошибок:

1. **HTTP ошибки** - если API вернул статус != 200
2. **Timeout** - если запрос превысил 30 секунд
3. **Исключения** - любые другие ошибки при обращении к API

В случае ошибки сервис возвращает `None`, и бот отправляет пользователю сообщение об ошибке.

## Безопасность

**Важно:** В текущей реализации отключена проверка SSL-сертификата для тестирования. Для продакшена необходимо включить проверку SSL-сертификата.

## Документация API Amvera

- **Swagger**: https://lllm-swagger-amvera-services.amvera.io/openapi.yaml
- **Документация**: https://lllm-swagger-amvera-services.amvera.io/#/GPT/post_models_gpt

## Переменные окружения

```env
BOT_TOKEN=ваш_токен_бота_telegram
AMVERA_LLM_TOKEN=ваш_токен_amvera_llm
CONTEXT7_API_KEY=ваш_ключ_context7
```

## Файлы, которые были созданы/обновлены

### Созданы:
- `src/bot/services/amvera_llm.py` - сервис для работы с Amvera LLM
- `tests/test_amvera_llm_service.py` - тесты для сервиса
- `USAGE.md` - руководство по использованию
- `INTEGRATION.md` - этот файл
- `.env.example` - пример конфигурации

### Обновлены:
- `src/bot/routers/chatgpt.py` - использование нового сервиса
- `src/bot/services/__init__.py` - экспорт нового сервиса
- `requirements.txt` - добавлены зависимости
- `README.md` - обновлена документация
- `tests/test_chatgpt_router.py` - обновлены тесты
